const { chromium } = require("playwright");

// List of URLs to test
const testUrls = [
  "https://10.239.47.2:8080/blur.html#renderer=webgpu&shaderType=compute&segmenter=triangle&webnnDevice=gpu&webrtcCodec=video%2FH264&displaySize=original",
  "https://10.239.47.2:8080/blur.html#renderer=webgpu&shaderType=compute&zeroCopy=on&segmenter=triangle&webnnDevice=gpu&webrtcCodec=video%2FH264&displaySize=original",
  "https://10.239.47.2:8080/blur.html#renderer=webgpu&shaderType=compute&zeroCopy=on&directOutput=on&segmenter=triangle&webnnDevice=gpu&webrtcCodec=video%2FH264&displaySize=original",
  "https://10.239.47.2:8080/blur.html#renderer=webgpu&shaderType=compute&directOutput=on&segmenter=triangle&webnnDevice=gpu&webrtcCodec=video%2FH264&displaySize=original",
  "https://10.239.47.2:8080/blur.html#renderer=webgpu&shaderType=fragment&segmenter=triangle&webnnDevice=gpu&webrtcCodec=video%2FH264&displaySize=original",
  "https://10.239.47.2:8080/blur.html#renderer=webgpu&shaderType=fragment&zeroCopy=on&segmenter=triangle&webnnDevice=gpu&webrtcCodec=video%2FH264&displaySize=original",
  "https://10.239.47.2:8080/blur.html#renderer=webgpu&shaderType=fragment&zeroCopy=on&directOutput=on&segmenter=triangle&webnnDevice=gpu&webrtcCodec=video%2FH264&displaySize=original",
  "https://10.239.47.2:8080/blur.html#renderer=webgpu&shaderType=fragment&directOutput=on&segmenter=triangle&webnnDevice=gpu&webrtcCodec=video%2FH264&displaySize=original",
  "https://10.239.47.2:8080/blur.html#renderer=webgl2&shaderType=fragment&directOutput=on&segmenter=triangle&webnnDevice=gpu&webrtcCodec=video%2FH264&displaySize=original",
];

function delay(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

async function main() {
  await testUrlsBatch(testUrls);
}
main();

async function testUrlsBatch(urls) {
  const browserPath = `${process.env.LOCALAPPDATA}/Google/Chrome SxS/Application/chrome.exe`;
  const userDataDir = `${process.env.LOCALAPPDATA}/Google/Chrome SxS/User Data11`;

  for (const url of urls) {
    let consoleError = null;
    let consoleWarning = null;
    const context = await chromium.launchPersistentContext(userDataDir, {
      headless: false,
      executablePath: browserPath,
      viewport: null,
      ignoreHTTPSErrors: true,
      permissions: ["camera", "microphone", "geolocation"],
      args: [
        "--start-maximized",
        "--disable-web-security",
        "--allow-running-insecure-content",
        "--disable-session-crashed-bubble",
        "--hide-crash-restore-bubble",
      ],
    });
    const page = await context.newPage();
    page.removeAllListeners("console");
    page.on("console", (msg) => {
      if (msg.type() === "error") {
        consoleError = msg.text();
      } else if (msg.type() === "warning") {
        consoleWarning = msg.text();
      }
    });

    console.log(`Open: ${url}`);
    await page.goto(url, { waitUntil: "networkidle" });
    /*
    try {
      await page.waitForFunction(
        () => typeof window.startVideoProcessing === "function",
        { timeout: 10000 }
      );
    } catch {
      console.error("startVideoProcessing is not defined after 10s");
      break;
    }*/

    try {
      /*
      await page.evaluate(() => {
        if (typeof startVideoProcessing === "function") {
          startVideoProcessing();
        } else {
          throw new Error("startVideoProcessing is not defined");
        }
      });
      */
      console.log("Click start button...");
      // await delay(100);
      const startButton = await page.$("#startButton");
      if (startButton) {
        await startButton.click();
      } else {
        throw new Error("Cannot find #startButton");
      }

      // console.log("Start video processing...");
    } catch (e) {
      console.error("Error calling startVideoProcessing:", e.message);
      break;
    }

    await new Promise((r) => setTimeout(r, 5000));

    if (consoleError) {
      console.error("Console error detected:", consoleError);
      // break;
    } else if (consoleWarning) {
      console.warn("Console warning detected:", consoleWarning);
      //break;
    }
    console.log("Close...");

    await context.close();
  }
}
